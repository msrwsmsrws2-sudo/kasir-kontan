<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KASIR KONTAN By SR</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #34495e;
            --info: #17a2b8;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 100%;
            padding: 20px;
        }
        
        /* LOGIN SCREEN */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary), var(--dark));
        }
        
        .login-box {
            background: white;
            padding: 40px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-header h1 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        .login-header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
        }
        
        .form-group label {
            font-weight: 600;
            color: var(--primary);
            font-size: 1em;
        }
        
        .form-group input, .form-group select {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus {
            border-color: var(--secondary);
            outline: none;
        }
        
        .password-toggle {
            position: absolute;
            right: 15px;
            top: 40px;
            background: none;
            border: none;
            color: #7f8c8d;
            cursor: pointer;
        }
        
        .login-btn {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 10px;
        }
        
        .login-btn:hover {
            background: #2980b9;
        }
        
        /* MAIN APPLICATION */
        .main-app {
            display: none;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--dark));
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .user-actions button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .logout-btn {
            background: var(--danger);
            color: white;
        }

        .change-password-btn {
            background: var(--warning);
            color: white;
        }
        
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .nav-tab {
            padding: 12px 20px;
            cursor: pointer;
            border-radius: 8px;
            margin-right: 10px;
            white-space: nowrap;
            transition: all 0.3s;
        }
        
        .nav-tab.active {
            background: var(--secondary);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .search-box {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 250px;
        }
        
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .btn-primary {
            background: var(--secondary);
            color: white;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-info {
            background: var(--info);
            color: white;
        }
        
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .menu-item {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: transform 0.3s;
            position: relative;
            background: white;
        }
        
        .menu-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .menu-item h3 {
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .menu-item .price {
            color: var(--danger);
            font-weight: bold;
            font-size: 1.2em;
            margin: 10px 0;
        }
        
        .stock-info {
            color: #7f8c8d;
            font-size: 0.9em;
            margin: 5px 0;
        }
        
        .out-of-stock {
            color: var(--danger);
            font-weight: bold;
        }
        
        .discount-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--danger);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .add-to-cart {
            background: var(--success);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            font-size: 1em;
        }
        
        .add-to-cart:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .cart-items {
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .cart-item-info {
            flex: 1;
        }
        
        .cart-item-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quantity-btn {
            background: var(--light);
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .quantity-btn.decrease {
            color: var(--danger);
        }
        
        .quantity-btn.increase {
            color: var(--success);
        }
        
        .cart-total {
            font-size: 1.3em;
            font-weight: bold;
            text-align: right;
            margin: 20px 0;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }
        
        .cart-actions {
            display: flex;
            gap: 10px;
        }
        
        .cart-actions button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1em;
        }
        
        .checkout-btn {
            background: var(--secondary);
            color: white;
        }
        
        .clear-btn {
            background: var(--danger);
            color: white;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 10px;
            padding: 25px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: var(--primary);
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #7f8c8d;
        }

        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .modal-form input, .modal-form select, .modal-form textarea {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .cancel-btn {
            background: var(--light);
            color: var(--dark);
        }

        .save-btn {
            background: var(--success);
            color: white;
        }

        /* Income Summary */
        .income-summary {
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .income-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .income-item {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
        }

        .income-value {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .income-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Reports Table */
        .reports-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .reports-table th, .reports-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        .reports-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: var(--primary);
        }

        .reports-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .edit-btn {
            background: var(--warning);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .delete-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .access-denied {
            color: #7f8c8d;
            font-style: italic;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .notification.success {
            background: var(--success);
        }
        
        .notification.error {
            background: var(--danger);
        }
        
        .notification.info {
            background: var(--info);
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-card {
            text-align: center;
            padding: 20px;
            background: var(--light);
            border-radius: 8px;
            border-left: 4px solid var(--secondary);
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        /* Chart Container */
        .chart-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .chart-card h3 {
            color: var(--primary);
            margin-bottom: 15px;
            text-align: center;
        }
        
        /* Payment Methods */
        .payment-methods {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .payment-method {
            flex: 1;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        
        .payment-method.selected {
            border-color: var(--secondary);
            background: rgba(52, 152, 219, 0.1);
        }
        
        .payment-method i {
            font-size: 2em;
            margin-bottom: 10px;
            display: block;
            color: var(--primary);
        }
        
        .payment-method .payment-label {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        
        .payment-method .payment-desc {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        /* Stock Management Styles */
        .stock-management-card {
            margin-top: 20px;
        }
        
        .stock-history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .stock-history-table th, .stock-history-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        .stock-history-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: var(--primary);
        }
        
        .stock-in {
            color: var(--success);
            font-weight: bold;
        }
        
        .stock-out {
            color: var(--danger);
            font-weight: bold;
        }
        
        .stock-adjustment {
            color: var(--warning);
            font-weight: bold;
        }
        
        .stock-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stock-summary-card {
            text-align: center;
            padding: 20px;
            background: var(--light);
            border-radius: 8px;
            border-left: 4px solid var(--info);
        }
        
        .stock-summary-value {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .stock-summary-label {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        .stock-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .stock-filter select, .stock-filter input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .stock-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .add-stock-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .adjust-stock-btn {
            background: var(--warning);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .stock-change-modal .modal {
            max-width: 400px;
        }
        
        .stock-change-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .stock-change-info {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .stock-change-info h4 {
            margin: 0 0 10px 0;
            color: var(--primary);
        }
        
        .stock-change-info p {
            margin: 5px 0;
        }
        
        .stock-change-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #printSection, #printSection * {
                visibility: visible;
            }
            #printSection {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 20px;
                background: white;
            }
            .no-print {
                display: none !important;
            }
        }
        
        .print-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .print-table th, .print-table td {
            border: 1px solid #000;
            padding: 8px;
            text-align: left;
        }
        
        .print-table th {
            background-color: #f0f0f0;
            font-weight: bold;
        }
        
        /* Print Preview Modal */
        .print-preview-modal {
            max-width: 90% !important;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .print-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .print-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .menu-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .nav-tab {
                flex: 1;
                text-align: center;
                margin-bottom: 5px;
            }
            
            .login-box {
                margin: 20px;
                padding: 30px 20px;
            }

            .user-actions {
                display: flex;
                flex-direction: column;
                gap: 5px;
            }

            .user-actions button {
                margin-left: 0;
                margin-bottom: 5px;
            }

            .income-grid {
                grid-template-columns: 1fr;
            }

            .reports-table, .products-table {
                font-size: 0.8em;
            }

            .reports-table th, .reports-table td,
            .products-table th, .products-table td {
                padding: 8px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .search-box {
                width: 100%;
                margin-top: 10px;
            }
            
            .card-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .chart-container {
                grid-template-columns: 1fr;
            }
            
            .payment-methods {
                flex-direction: column;
            }
            
            .stock-filter {
                flex-direction: column;
            }
            
            .stock-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <div class="login-header">
                <h1>KASIR KONTAN By SR</h1>
                <p>Sistem Kasir Restoran</p>
            </div>
            
            <div class="login-form">
                <div class="form-group">
                    <label for="loginUsername">Username</label>
                    <select id="loginUsername">
                        <option value="">Pilih User</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="Masukkan password">
                    <button type="button" class="password-toggle" onclick="togglePassword('loginPassword')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                
                <button class="login-btn" onclick="handleLogin()">Login</button>
            </div>
        </div>
    </div>

    <!-- MAIN APPLICATION -->
    <div class="main-app" id="mainApp">
        <div class="container">
            <header>
                <h1>KASIR KONTAN By SR</h1>
                <p>Sistem Kasir Restoran - Siap Melayani</p>
            </header>

            <div class="user-info">
                <div>
                    <span id="userDisplay">User: </span>
                    <span style="color: var(--success);">
                        <i class="fas fa-circle"></i> Online
                    </span>
                </div>
                <div class="user-actions">
                    <button class="change-password-btn" onclick="showChangePasswordModal()">
                        <i class="fas fa-key"></i> Ganti Password
                    </button>
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <div class="nav-tab active" onclick="switchTab('dashboard')">
                    <i class="fas fa-chart-bar"></i> Dashboard
                </div>
                <div class="nav-tab" onclick="switchTab('menu')">
                    <i class="fas fa-utensils"></i> Menu & Kasir
                </div>
                <div class="nav-tab" onclick="switchTab('products')" id="productsTab">
                    <i class="fas fa-box"></i> Kelola Produk
                </div>
                <div class="nav-tab" onclick="switchTab('stockReports')" id="stockReportsTab">
                    <i class="fas fa-chart-line"></i> Laporan Stok
                </div>
                <div class="nav-tab" onclick="switchTab('reports')">
                    <i class="fas fa-file-alt"></i> Laporan Penjualan
                </div>
                <div class="nav-tab" onclick="switchTab('users')" id="usersTab">
                    <i class="fas fa-users"></i> Kelola User
                </div>
                <div class="nav-tab" onclick="switchTab('closing')" id="closingTab">
                    <i class="fas fa-book"></i> Tutup Buku
                </div>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div class="card">
                    <h2>Statistik Hari Ini</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="todaySales">0</div>
                            <div class="stat-label">Transaksi</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="todayRevenue">Rp 0</div>
                            <div class="stat-label">Pendapatan</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="avgTransaction">Rp 0</div>
                            <div class="stat-label">Rata-rata Transaksi</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="popularItemCount">0</div>
                            <div class="stat-label">Item Terjual</div>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-card">
                        <h3>Produk Terlaris</h3>
                        <canvas id="popularProductsChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>Pendapatan Harian</h3>
                        <canvas id="dailyRevenueChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Menu & Kasir Tab -->
            <div id="menu" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2>Menu Makanan</h2>
                        <input type="text" class="search-box" id="menuSearch" placeholder="Cari menu..." onkeyup="filterMenu()">
                    </div>
                    
                    <div class="menu-grid" id="menuGrid">
                        <!-- Menu items will be loaded dynamically -->
                    </div>
                </div>

                <div class="card">
                    <h2>Keranjang Belanja</h2>
                    <div class="cart-items" id="cartItems">
                        <p style="text-align: center; padding: 20px; color: #7f8c8d;">Keranjang kosong</p>
                    </div>
                    
                    <div class="cart-total" id="cartTotal">
                        Total: Rp 0
                    </div>
                    
                    <div class="cart-actions">
                        <button class="clear-btn" onclick="clearCart()">
                            <i class="fas fa-trash"></i> Kosongkan
                        </button>
                        <button class="checkout-btn" onclick="showCheckoutModal()">
                            <i class="fas fa-cash-register"></i> Bayar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Products Management Tab -->
            <div id="products" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2>Kelola Produk</h2>
                        <button class="btn btn-primary" onclick="showAddProductModal()">
                            <i class="fas fa-plus"></i> Tambah Produk
                        </button>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table class="products-table">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Nama Produk</th>
                                    <th>Kategori</th>
                                    <th>Harga</th>
                                    <th>Stok</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="productsList">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 20px; color: #7f8c8d;">
                                        Loading data produk...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Stock Reports Tab -->
            <div id="stockReports" class="tab-content">
                <div class="card">
                    <h2>Laporan Stok</h2>
                    
                    <div class="stock-filter">
                        <select id="stockPeriodFilter" onchange="filterStockReports()">
                            <option value="today">Hari Ini</option>
                            <option value="week">Minggu Ini</option>
                            <option value="month">Bulan Ini</option>
                            <option value="all">Semua</option>
                        </select>
                        
                        <select id="stockTypeFilter" onchange="filterStockReports()">
                            <option value="all">Semua Jenis</option>
                            <option value="in">Stok Masuk</option>
                            <option value="out">Stok Keluar</option>
                            <option value="adjustment">Penyesuaian</option>
                        </select>
                        
                        <select id="stockProductFilter" onchange="filterStockReports()">
                            <option value="all">Semua Produk</option>
                        </select>
                        
                        <button class="btn btn-info" onclick="exportStockReports()">
                            <i class="fas fa-download"></i> Export Excel
                        </button>
                    </div>
                    
                    <div class="stock-summary-grid">
                        <div class="stock-summary-card">
                            <div class="stock-summary-value" id="totalStockIn">0</div>
                            <div class="stock-summary-label">Stok Masuk</div>
                        </div>
                        <div class="stock-summary-card">
                            <div class="stock-summary-value" id="totalStockOut">0</div>
                            <div class="stock-summary-label">Stok Keluar</div>
                        </div>
                        <div class="stock-summary-card">
                            <div class="stock-summary-value" id="totalStockAdjustment">0</div>
                            <div class="stock-summary-label">Penyesuaian</div>
                        </div>
                        <div class="stock-summary-card">
                            <div class="stock-summary-value" id="totalStockChanges">0</div>
                            <div class="stock-summary-label">Total Perubahan</div>
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto; margin-top: 20px;">
                        <table class="stock-history-table">
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Produk</th>
                                    <th>Jenis</th>
                                    <th>Jumlah</th>
                                    <th>Stok Sebelum</th>
                                    <th>Stok Sesudah</th>
                                    <th>Keterangan</th>
                                    <th>User</th>
                                </tr>
                            </thead>
                            <tbody id="stockHistoryList">
                                <tr>
                                    <td colspan="8" style="text-align: center; padding: 20px; color: #7f8c8d;">
                                        Loading data stok...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports" class="tab-content">
                <!-- Income Summary -->
                <div class="income-summary">
                    <h2 style="color: white; text-align: center; margin-bottom: 15px;">Ringkasan Pendapatan</h2>
                    <div class="income-grid">
                        <div class="income-item">
                            <div class="income-value" id="dailyIncome">Rp 0</div>
                            <div class="income-label">Hari Ini</div>
                        </div>
                        <div class="income-item">
                            <div class="income-value" id="monthlyIncome">Rp 0</div>
                            <div class="income-label">Bulan Ini</div>
                        </div>
                        <div class="income-item">
                            <div class="income-value" id="weeklyIncome">Rp 0</div>
                            <div class="income-label">Minggu Ini</div>
                        </div>
                        <div class="income-item">
                            <div class="income-value" id="totalTransactions">0</div>
                            <div class="income-label">Total Transaksi</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>Laporan Transaksi</h2>
                        <div>
                            <select id="reportFilter" onchange="filterReports()" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-right: 10px;">
                                <option value="today">Hari Ini</option>
                                <option value="week">Minggu Ini</option>
                                <option value="month">Bulan Ini</option>
                                <option value="all">Semua</option>
                            </select>
                            <button onclick="showPrintPreview()" style="background: var(--info); color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                                <i class="fas fa-print"></i> Print
                            </button>
                            <button onclick="exportReports()" style="background: var(--success); color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;">
                                <i class="fas fa-download"></i> Export Excel
                            </button>
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table class="reports-table">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Tanggal</th>
                                    <th>Kasir</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Metode Bayar</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="reportsList">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 20px; color: #7f8c8d;">
                                        Belum ada transaksi
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Users Management Tab -->
            <div id="users" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2>Kelola User</h2>
                        <button class="btn btn-primary" onclick="showAddUserModal()">
                            <i class="fas fa-plus"></i> Tambah User
                        </button>
                    </div>
                    <div id="usersList">
                        <p>Loading daftar user...</p>
                    </div>
                </div>
            </div>

            <!-- Closing Tab -->
            <div id="closing" class="tab-content">
                <div class="card">
                    <h2>Tutup Buku Bulanan</h2>
                    <div class="income-summary">
                        <h3 style="color: white; text-align: center;">Ringkasan Bulan Ini</h3>
                        <div class="income-grid">
                            <div class="income-item">
                                <div class="income-value" id="closingMonthlyIncome">Rp 0</div>
                                <div class="income-label">Total Pendapatan</div>
                            </div>
                            <div class="income-item">
                                <div class="income-value" id="closingTotalTransactions">0</div>
                                <div class="income-label">Total Transaksi</div>
                            </div>
                            <div class="income-item">
                                <div class="income-value" id="closingAvgTransaction">Rp 0</div>
                                <div class="income-label">Rata-rata Transaksi</div>
                            </div>
                            <div class="income-item">
                                <div class="income-value" id="closingPeriod">-</div>
                                <div class="income-label">Periode</div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <button class="btn btn-warning" onclick="showClosingConfirmation()" style="width: 100%; padding: 15px;">
                            <i class="fas fa-lock"></i> Proses Tutup Buku Bulan Ini
                        </button>
                        <p style="text-align: center; margin-top: 10px; color: #7f8c8d;">
                            * Tutup buku akan mengarsipkan data bulan ini dan mereset statistik
                        </p>
                    </div>

                    <div class="card" style="margin-top: 20px;">
                        <h3>Riwayat Tutup Buku</h3>
                        <div id="closingHistory">
                            <p style="text-align: center; padding: 20px; color: #7f8c8d;">
                                Belum ada riwayat tutup buku
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <!-- Change Password Modal -->
    <div class="modal-overlay" id="changePasswordModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Ganti Password</h3>
                <button class="close-modal" onclick="hideChangePasswordModal()">&times;</button>
            </div>
            <div class="modal-form">
                <div class="form-group">
                    <label for="currentPassword">Password Saat Ini</label>
                    <input type="password" id="currentPassword" placeholder="Password saat ini">
                    <button type="button" class="password-toggle" onclick="togglePassword('currentPassword')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div class="form-group">
                    <label for="newPassword">Password Baru</label>
                    <input type="password" id="newPassword" placeholder="Password baru (min. 6 karakter)">
                    <button type="button" class="password-toggle" onclick="togglePassword('newPassword')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Konfirmasi Password Baru</label>
                    <input type="password" id="confirmPassword" placeholder="Konfirmasi password baru">
                    <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="hideChangePasswordModal()">Batal</button>
                <button class="save-btn" onclick="changePassword()">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div class="modal-overlay" id="productModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="productModalTitle">Tambah Produk</h3>
                <button class="close-modal" onclick="hideProductModal()">&times;</button>
            </div>
            <div class="modal-form">
                <input type="hidden" id="productId">
                <input type="text" id="productName" placeholder="Nama produk">
                <select id="productCategory">
                    <option value="">Pilih Kategori</option>
                    <option value="makanan">Makanan</option>
                    <option value="minuman">Minuman</option>
                    <option value="snack">Snack</option>
                </select>
                <input type="number" id="productPrice" placeholder="Harga">
                <input type="number" id="productStock" placeholder="Stok awal">
                <textarea id="productDescription" placeholder="Deskripsi produk" rows="3"></textarea>
            </div>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="hideProductModal()">Batal</button>
                <button class="save-btn" onclick="saveProduct()">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div class="modal-overlay" id="userModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="userModalTitle">Tambah User</h3>
                <button class="close-modal" onclick="hideUserModal()">&times;</button>
            </div>
            <div class="modal-form">
                <input type="hidden" id="userId">
                <input type="text" id="userName" placeholder="Nama lengkap">
                <input type="text" id="userUsername" placeholder="Username">
                <select id="userRole">
                    <option value="kasir">Kasir</option>
                    <option value="admin">Admin</option>
                    <option value="gudang">Admin Gudang</option>
                </select>
                <div class="form-group">
                    <label for="userPassword">Password</label>
                    <input type="password" id="userPassword" placeholder="Password (min. 6 karakter)">
                    <button type="button" class="password-toggle" onclick="togglePassword('userPassword')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="hideUserModal()">Batal</button>
                <button class="save-btn" onclick="saveUser()">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div class="modal-overlay" id="checkoutModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Pembayaran</h3>
                <button class="close-modal" onclick="hideCheckoutModal()">&times;</button>
            </div>
            <div class="modal-form">
                <h4 style="margin-bottom: 15px;">Pilih Metode Pembayaran:</h4>
                <div class="payment-methods">
                    <div class="payment-method" id="cashMethod" onclick="selectPaymentMethod('cash')">
                        <i class="fas fa-money-bill-wave"></i>
                        <div class="payment-label">Tunai</div>
                        <div class="payment-desc">Bayar dengan uang tunai</div>
                    </div>
                    <div class="payment-method" id="qrisMethod" onclick="selectPaymentMethod('qris')">
                        <i class="fas fa-qrcode"></i>
                        <div class="payment-label">QRIS</div>
                        <div class="payment-desc">Scan QR Code untuk pembayaran</div>
                    </div>
                </div>
                
                <div class="payment-summary" style="margin-top: 20px; padding: 15px; background: var(--light); border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>Total Pembayaran:</span>
                        <span id="checkoutTotal" style="font-weight: bold; font-size: 1.2em;">Rp 0</span>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="hideCheckoutModal()">Batal</button>
                <button class="save-btn" id="confirmCheckoutBtn" onclick="confirmCheckout()">
                    <i class="fas fa-cash-register"></i> Konfirmasi Bayar
                </button>
            </div>
        </div>
    </div>

    <!-- Add Stock Modal -->
    <div class="modal-overlay stock-change-modal" id="addStockModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Tambah Stok Produk</h3>
                <button class="close-modal" onclick="hideAddStockModal()">&times;</button>
            </div>
            <div class="modal-form">
                <div class="stock-change-info">
                    <h4 id="addStockProductName">-</h4>
                    <p>Stok saat ini: <span id="addStockCurrentStock">0</span></p>
                </div>
                <input type="hidden" id="addStockProductId">
                <div class="form-group">
                    <label for="addStockQuantity">Jumlah Stok yang Ditambahkan</label>
                    <input type="number" id="addStockQuantity" min="1" value="1">
                </div>
                <div class="form-group">
                    <label for="addStockNotes">Keterangan (opsional)</label>
                    <textarea id="addStockNotes" rows="3" placeholder="Catatan tambahan..."></textarea>
                </div>
            </div>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="hideAddStockModal()">Batal</button>
                <button class="save-btn" onclick="confirmAddStock()">Tambah Stok</button>
            </div>
        </div>
    </div>

    <!-- Adjust Stock Modal -->
    <div class="modal-overlay stock-change-modal" id="adjustStockModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Penyesuaian Stok Produk</h3>
                <button class="close-modal" onclick="hideAdjustStockModal()">&times;</button>
            </div>
            <div class="modal-form">
                <div class="stock-change-info">
                    <h4 id="adjustStockProductName">-</h4>
                    <p>Stok saat ini: <span id="adjustStockCurrentStock">0</span></p>
                </div>
                <input type="hidden" id="adjustStockProductId">
                <div class="form-group">
                    <label for="adjustStockQuantity">Stok Baru</label>
                    <input type="number" id="adjustStockQuantity" min="0" value="0">
                </div>
                <div class="form-group">
                    <label for="adjustStockNotes">Keterangan (opsional)</label>
                    <textarea id="adjustStockNotes" rows="3" placeholder="Alasan penyesuaian stok..."></textarea>
                </div>
            </div>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="hideAdjustStockModal()">Batal</button>
                <button class="save-btn" onclick="confirmAdjustStock()">Simpan Penyesuaian</button>
            </div>
        </div>
    </div>

    <!-- Print Preview Modal -->
    <div class="modal-overlay" id="printPreviewModal">
        <div class="modal print-preview-modal">
            <div class="modal-header">
                <h3>Print Preview - Laporan Transaksi</h3>
                <button class="close-modal" onclick="hidePrintPreviewModal()">&times;</button>
            </div>
            <div class="modal-form">
                <div id="printPreviewContent">
                    <!-- Print preview content will be loaded here -->
                </div>
            </div>
            <div class="print-actions">
                <button class="cancel-btn" onclick="hidePrintPreviewModal()">Tutup</button>
                <button class="save-btn" onclick="printReports()">
                    <i class="fas fa-print"></i> Print
                </button>
            </div>
        </div>
    </div>

    <!-- Closing Confirmation Modal -->
    <div class="modal-overlay" id="closingConfirmationModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Konfirmasi Tutup Buku</h3>
                <button class="close-modal" onclick="hideClosingConfirmationModal()">&times;</button>
            </div>
            <div class="modal-form">
                <p>Apakah Anda yakin ingin melakukan tutup buku untuk bulan ini?</p>
                <p><strong>Periode:</strong> <span id="closingPeriodText"></span></p>
                <p><strong>Total Pendapatan:</strong> <span id="closingTotalText"></span></p>
                <p><strong>Total Transaksi:</strong> <span id="closingTransactionsText"></span></p>
                <p style="color: var(--danger); font-weight: bold;">
                    <i class="fas fa-exclamation-triangle"></i> 
                    Tindakan ini tidak dapat dibatalkan!
                </p>
            </div>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="hideClosingConfirmationModal()">Batal</button>
                <button class="save-btn" onclick="processClosing()">
                    <i class="fas fa-lock"></i> Proses Tutup Buku
                </button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <!-- Hidden Print Section -->
    <div id="printSection" style="display: none;"></div>

    <script>
        // ==================== DATA MANAGEMENT ====================
        
        const defaultUsers = {
            'admin': { 
                password: 'admin123', 
                role: 'admin', 
                name: 'Administrator',
                createdBy: 'system'
            },
            'kasir1': { 
                password: 'kasir123', 
                role: 'kasir', 
                name: 'Kasir 1',
                createdBy: 'system'
            },
            'gudang1': { 
                password: 'gudang123', 
                role: 'gudang', 
                name: 'Admin Gudang 1',
                createdBy: 'system'
            }
        };

        const defaultProducts = [
            {
                id: 1,
                name: 'PAKET AYAM',
                category: 'makanan',
                price: 17000,
                stock: 50,
                description: '+ Nasi, Lalapan, Sambel, Teh Tawar'
            },
            {
                id: 2,
                name: 'PAKET IKAN',
                category: 'makanan',
                price: 17000,
                stock: 30,
                description: '+ Nasi, Lalapan, Sambel, Teh Tawar'
            },
            {
                id: 3,
                name: 'PAKET DAGING',
                category: 'makanan',
                price: 20000,
                stock: 20,
                description: '+ Nasi, Lalapan, Sambel, Teh Tawar'
            },
            {
                id: 4,
                name: 'PAKET TELUR',
                category: 'makanan',
                price: 14000,
                stock: 40,
                description: '+ Nasi, Lalapan, Sambel, Teh Tawar'
            },
            {
                id: 5,
                name: 'PAKET CAMPUR',
                category: 'makanan',
                price: 22000,
                stock: 25,
                description: 'Ayam + Telur, Nasi, Lalapan, Sambel, Teh Tawar'
            },
            {
                id: 6,
                name: 'EXTRA NASI',
                category: 'makanan',
                price: 3000,
                stock: 100,
                description: 'Nasi tambahan'
            }
        ];

        // Chart instances
        let popularProductsChart = null;
        let dailyRevenueChart = null;

        function initializeData() {
            try {
                if (!localStorage.getItem('kasirUsers')) {
                    localStorage.setItem('kasirUsers', JSON.stringify(defaultUsers));
                }
                
                if (!localStorage.getItem('kasirProducts')) {
                    localStorage.setItem('kasirProducts', JSON.stringify(defaultProducts));
                }
                
                if (!localStorage.getItem('kasirTransactions')) {
                    localStorage.setItem('kasirTransactions', JSON.stringify([]));
                }
                
                if (!localStorage.getItem('kasirSettings')) {
                    localStorage.setItem('kasirSettings', JSON.stringify({
                        taxRate: 0, // Changed to 0 to remove PPN
                        currency: 'IDR'
                    }));
                }
                
                if (!localStorage.getItem('kasirClosingHistory')) {
                    localStorage.setItem('kasirClosingHistory', JSON.stringify([]));
                }
                
                if (!localStorage.getItem('kasirStockHistory')) {
                    localStorage.setItem('kasirStockHistory', JSON.stringify([]));
                }
                
                return true;
            } catch (error) {
                if (!sessionStorage.getItem('kasirUsers')) {
                    sessionStorage.setItem('kasirUsers', JSON.stringify(defaultUsers));
                }
                if (!sessionStorage.getItem('kasirProducts')) {
                    sessionStorage.setItem('kasirProducts', JSON.stringify(defaultProducts));
                }
                if (!sessionStorage.getItem('kasirTransactions')) {
                    sessionStorage.setItem('kasirTransactions', JSON.stringify([]));
                }
                if (!sessionStorage.getItem('kasirSettings')) {
                    sessionStorage.setItem('kasirSettings', JSON.stringify({
                        taxRate: 0, // Changed to 0 to remove PPN
                        currency: 'IDR'
                    }));
                }
                if (!sessionStorage.getItem('kasirClosingHistory')) {
                    sessionStorage.setItem('kasirClosingHistory', JSON.stringify([]));
                }
                if (!sessionStorage.getItem('kasirStockHistory')) {
                    sessionStorage.setItem('kasirStockHistory', JSON.stringify([]));
                }
                return true;
            }
        }

        function getUsers() {
            try {
                const users = localStorage.getItem('kasirUsers') || sessionStorage.getItem('kasirUsers');
                return JSON.parse(users) || defaultUsers;
            } catch (error) {
                return defaultUsers;
            }
        }

        function saveUsers(users) {
            try {
                localStorage.setItem('kasirUsers', JSON.stringify(users));
            } catch (error) {
                sessionStorage.setItem('kasirUsers', JSON.stringify(users));
            }
        }

        function getProducts() {
            try {
                const products = localStorage.getItem('kasirProducts') || sessionStorage.getItem('kasirProducts');
                return JSON.parse(products) || defaultProducts;
            } catch (error) {
                return defaultProducts;
            }
        }

        function saveProducts(products) {
            try {
                localStorage.setItem('kasirProducts', JSON.stringify(products));
            } catch (error) {
                sessionStorage.setItem('kasirProducts', JSON.stringify(products));
            }
        }

        function getTransactions() {
            try {
                const transactions = localStorage.getItem('kasirTransactions') || sessionStorage.getItem('kasirTransactions');
                return JSON.parse(transactions) || [];
            } catch (error) {
                return [];
            }
        }

        function saveTransactions(transactions) {
            try {
                localStorage.setItem('kasirTransactions', JSON.stringify(transactions));
            } catch (error) {
                sessionStorage.setItem('kasirTransactions', JSON.stringify(transactions));
            }
        }

        function getClosingHistory() {
            try {
                const history = localStorage.getItem('kasirClosingHistory') || sessionStorage.getItem('kasirClosingHistory');
                return JSON.parse(history) || [];
            } catch (error) {
                return [];
            }
        }

        function saveClosingHistory(history) {
            try {
                localStorage.setItem('kasirClosingHistory', JSON.stringify(history));
            } catch (error) {
                sessionStorage.setItem('kasirClosingHistory', JSON.stringify(history));
            }
        }

        function getStockHistory() {
            try {
                const history = localStorage.getItem('kasirStockHistory') || sessionStorage.getItem('kasirStockHistory');
                return JSON.parse(history) || [];
            } catch (error) {
                return [];
            }
        }

        function saveStockHistory(history) {
            try {
                localStorage.setItem('kasirStockHistory', JSON.stringify(history));
            } catch (error) {
                sessionStorage.setItem('kasirStockHistory', JSON.stringify(history));
            }
        }

        function getSettings() {
            try {
                const settings = localStorage.getItem('kasirSettings') || sessionStorage.getItem('kasirSettings');
                return JSON.parse(settings) || { taxRate: 0, currency: 'IDR' };
            } catch (error) {
                return { taxRate: 0, currency: 'IDR' };
            }
        }

        // ==================== APPLICATION STATE ====================
        
        let currentUser = null;
        let cart = [];
        let selectedUserForPasswordChange = null;
        let selectedTransactionForEdit = null;
        let selectedPaymentMethod = null;
        let editingProductId = null;
        let editingUserId = null;

        // ==================== UTILITY FUNCTIONS ====================
        
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        function formatCurrency(amount) {
            return 'Rp ' + amount.toLocaleString('id-ID');
        }

        // ==================== LOGIN SYSTEM ====================
        
        function loadLoginUsers() {
            const users = getUsers();
            const loginSelect = document.getElementById('loginUsername');
            loginSelect.innerHTML = '<option value="">Pilih User</option>';
            
            Object.entries(users).forEach(([username, user]) => {
                const option = document.createElement('option');
                option.value = username;
                option.textContent = `${user.name} (${user.role})`;
                loginSelect.appendChild(option);
            });
        }

        function handleLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!username) {
                showNotification('Pilih user terlebih dahulu!', 'error');
                return;
            }
            
            if (!password) {
                showNotification('Masukkan password!', 'error');
                return;
            }
            
            const users = getUsers();
            
            if (users[username] && users[username].password === password) {
                currentUser = {
                    username: username,
                    name: users[username].name,
                    role: users[username].role
                };
                
                initializeData();
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                
                document.getElementById('userDisplay').textContent = `User: ${currentUser.name} (${currentUser.role})`;
                
                // Show/hide tabs based on role
                if (currentUser.role === 'admin') {
                    document.getElementById('usersTab').style.display = 'block';
                    document.getElementById('productsTab').style.display = 'block';
                    document.getElementById('stockReportsTab').style.display = 'block';
                    document.getElementById('closingTab').style.display = 'block';
                } else if (currentUser.role === 'gudang') {
                    document.getElementById('usersTab').style.display = 'none';
                    document.getElementById('productsTab').style.display = 'block';
                    document.getElementById('stockReportsTab').style.display = 'block';
                    document.getElementById('closingTab').style.display = 'none';
                } else {
                    document.getElementById('usersTab').style.display = 'none';
                    document.getElementById('productsTab').style.display = 'none';
                    document.getElementById('stockReportsTab').style.display = 'none';
                    document.getElementById('closingTab').style.display = 'none';
                }
                
                showNotification(`Login berhasil! Selamat datang ${currentUser.name}`);
                
                updateDashboard();
                loadProductsList();
                loadUsersList();
                loadMenuItems();
                loadStockReports();
                
            } else {
                showNotification('Username atau password salah!', 'error');
            }
        }

        function logout() {
            currentUser = null;
            cart = [];
            selectedUserForPasswordChange = null;
            selectedTransactionForEdit = null;
            selectedPaymentMethod = null;
            editingProductId = null;
            editingUserId = null;
            
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            
            showNotification('Anda telah logout', 'info');
        }

        // ==================== TAB MANAGEMENT ====================
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'reports') {
                loadReports();
                updateIncomeSummary();
            } else if (tabName === 'users') {
                loadUsersList();
            } else if (tabName === 'products') {
                loadProductsList();
            } else if (tabName === 'menu') {
                document.getElementById('menuSearch').value = '';
                filterMenu();
            } else if (tabName === 'closing') {
                updateClosingSummary();
                loadClosingHistory();
            } else if (tabName === 'stockReports') {
                loadStockReports();
            }
        }

        // ==================== PRODUCTS MANAGEMENT ====================
        
        function loadProductsList() {
            const products = getProducts();
            const productsList = document.getElementById('productsList');
            
            if (products.length === 0) {
                productsList.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 20px; color: #7f8c8d;">
                            Belum ada produk
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            
            products.forEach((product, index) => {
                const stockClass = product.stock === 0 ? 'stock-out' : (product.stock < 10 ? 'stock-low' : '');
                const stockStatus = product.stock === 0 ? 'Habis' : (product.stock < 10 ? 'Menipis' : 'Tersedia');
                
                // Tentukan aksi berdasarkan role
                let actionButtons = '';
                
                if (currentUser.role === 'admin') {
                    actionButtons = `
                        <div class="action-buttons">
                            <button class="edit-btn" onclick="editProduct(${product.id})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="add-stock-btn" onclick="showAddStockModal(${product.id})">
                                <i class="fas fa-plus"></i> Stok
                            </button>
                            <button class="adjust-stock-btn" onclick="showAdjustStockModal(${product.id})">
                                <i class="fas fa-adjust"></i> Sesuaikan
                            </button>
                            <button class="delete-btn" onclick="deleteProduct(${product.id})">
                                <i class="fas fa-trash"></i> Hapus
                            </button>
                        </div>
                    `;
                } else if (currentUser.role === 'gudang') {
                    actionButtons = `
                        <div class="action-buttons">
                            <button class="add-stock-btn" onclick="showAddStockModal(${product.id})">
                                <i class="fas fa-plus"></i> Tambah Stok
                            </button>
                            <button class="adjust-stock-btn" onclick="showAdjustStockModal(${product.id})">
                                <i class="fas fa-adjust"></i> Sesuaikan Stok
                            </button>
                        </div>
                    `;
                } else {
                    actionButtons = '<span class="access-denied">Tidak ada akses</span>';
                }
                
                html += `
                    <tr class="${stockClass}">
                        <td>${index + 1}</td>
                        <td><strong>${product.name}</strong></td>
                        <td>${product.category}</td>
                        <td>${formatCurrency(product.price)}</td>
                        <td>${product.stock}</td>
                        <td>${stockStatus}</td>
                        <td>
                            ${actionButtons}
                        </td>
                    </tr>
                `;
            });
            
            productsList.innerHTML = html;
        }

        function showAddProductModal() {
            editingProductId = null;
            document.getElementById('productModalTitle').textContent = 'Tambah Produk';
            document.getElementById('productId').value = '';
            document.getElementById('productName').value = '';
            document.getElementById('productCategory').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productStock').value = '';
            document.getElementById('productDescription').value = '';
            document.getElementById('productModal').classList.add('active');
        }

        function editProduct(productId) {
            const products = getProducts();
            const product = products.find(p => p.id === productId);
            
            if (product) {
                editingProductId = productId;
                document.getElementById('productModalTitle').textContent = 'Edit Produk';
                document.getElementById('productId').value = product.id;
                document.getElementById('productName').value = product.name;
                document.getElementById('productCategory').value = product.category;
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productStock').value = product.stock;
                document.getElementById('productDescription').value = product.description || '';
                document.getElementById('productModal').classList.add('active');
            }
        }

        function hideProductModal() {
            document.getElementById('productModal').classList.remove('active');
            editingProductId = null;
        }

        function saveProduct() {
            const name = document.getElementById('productName').value;
            const category = document.getElementById('productCategory').value;
            const price = parseInt(document.getElementById('productPrice').value);
            const stock = parseInt(document.getElementById('productStock').value);
            const description = document.getElementById('productDescription').value;
            
            if (!name || !category || !price || stock < 0) {
                showNotification('Harap isi semua field dengan benar!', 'error');
                return;
            }
            
            const products = getProducts();
            
            if (editingProductId) {
                // Edit existing product
                const index = products.findIndex(p => p.id === editingProductId);
                if (index !== -1) {
                    products[index] = {
                        ...products[index],
                        name,
                        category,
                        price,
                        stock,
                        description
                    };
                }
                showNotification('Produk berhasil diupdate!');
            } else {
                // Add new product
                const newId = Math.max(...products.map(p => p.id), 0) + 1;
                products.push({
                    id: newId,
                    name,
                    category,
                    price,
                    stock,
                    description
                });
                showNotification('Produk berhasil ditambahkan!');
            }
            
            saveProducts(products);
            hideProductModal();
            loadProductsList();
            loadMenuItems();
        }

        function deleteProduct(productId) {
            if (!confirm('Apakah Anda yakin ingin menghapus produk ini?')) {
                return;
            }
            
            const products = getProducts();
            const filteredProducts = products.filter(p => p.id !== productId);
            saveProducts(filteredProducts);
            
            showNotification('Produk berhasil dihapus!');
            loadProductsList();
            loadMenuItems();
        }

        // ==================== STOCK MANAGEMENT FUNCTIONS ====================
        
        function recordStockChange(productId, type, quantity, previousStock, notes = '') {
            const products = getProducts();
            const product = products.find(p => p.id === productId);
            
            if (!product) return;
            
            const stockHistory = getStockHistory();
            
            stockHistory.push({
                id: Date.now(),
                productId: productId,
                productName: product.name,
                type: type, // 'in', 'out', 'adjustment'
                quantity: quantity,
                previousStock: previousStock,
                newStock: product.stock,
                notes: notes,
                user: currentUser.name,
                timestamp: new Date().toLocaleString('id-ID')
            });
            
            saveStockHistory(stockHistory);
        }

        function showAddStockModal(productId) {
            const products = getProducts();
            const product = products.find(p => p.id === productId);
            
            if (!product) {
                showNotification('Produk tidak ditemukan!', 'error');
                return;
            }
            
            document.getElementById('addStockProductId').value = productId;
            document.getElementById('addStockProductName').textContent = product.name;
            document.getElementById('addStockCurrentStock').textContent = product.stock;
            document.getElementById('addStockQuantity').value = 1;
            document.getElementById('addStockNotes').value = '';
            
            document.getElementById('addStockModal').classList.add('active');
        }

        function hideAddStockModal() {
            document.getElementById('addStockModal').classList.remove('active');
        }

        function confirmAddStock() {
            const productId = parseInt(document.getElementById('addStockProductId').value);
            const quantity = parseInt(document.getElementById('addStockQuantity').value);
            const notes = document.getElementById('addStockNotes').value;
            
            if (!quantity || quantity <= 0) {
                showNotification('Jumlah stok harus lebih dari 0!', 'error');
                return;
            }
            
            const products = getProducts();
            const productIndex = products.findIndex(p => p.id === productId);
            
            if (productIndex === -1) {
                showNotification('Produk tidak ditemukan!', 'error');
                return;
            }
            
            const previousStock = products[productIndex].stock;
            products[productIndex].stock += quantity;
            
            saveProducts(products);
            
            // Catat perubahan stok
            recordStockChange(productId, 'in', quantity, previousStock, notes);
            
            showNotification(`Stok ${products[productIndex].name} berhasil ditambahkan sebanyak ${quantity}`);
            
            hideAddStockModal();
            
            // Perbarui tampilan
            loadProductsList();
            loadMenuItems();
            loadStockReports();
        }

        function showAdjustStockModal(productId) {
            const products = getProducts();
            const product = products.find(p => p.id === productId);
            
            if (!product) {
                showNotification('Produk tidak ditemukan!', 'error');
                return;
            }
            
            document.getElementById('adjustStockProductId').value = productId;
            document.getElementById('adjustStockProductName').textContent = product.name;
            document.getElementById('adjustStockCurrentStock').textContent = product.stock;
            document.getElementById('adjustStockQuantity').value = product.stock;
            document.getElementById('adjustStockNotes').value = '';
            
            document.getElementById('adjustStockModal').classList.add('active');
        }

        function hideAdjustStockModal() {
            document.getElementById('adjustStockModal').classList.remove('active');
        }

        function confirmAdjustStock() {
            const productId = parseInt(document.getElementById('adjustStockProductId').value);
            const newStock = parseInt(document.getElementById('adjustStockQuantity').value);
            const notes = document.getElementById('adjustStockNotes').value;
            
            if (newStock < 0) {
                showNotification('Stok tidak boleh negatif!', 'error');
                return;
            }
            
            const products = getProducts();
            const productIndex = products.findIndex(p => p.id === productId);
            
            if (productIndex === -1) {
                showNotification('Produk tidak ditemukan!', 'error');
                return;
            }
            
            const previousStock = products[productIndex].stock;
            const adjustment = newStock - previousStock;
            
            products[productIndex].stock = newStock;
            
            saveProducts(products);
            
            // Catat perubahan stok
            recordStockChange(productId, 'adjustment', adjustment, previousStock, notes);
            
            showNotification(`Stok ${products[productIndex].name} berhasil disesuaikan dari ${previousStock} menjadi ${newStock}`);
            
            hideAdjustStockModal();
            
            // Perbarui tampilan
            loadProductsList();
            loadMenuItems();
            loadStockReports();
        }

        // ==================== STOCK REPORTS FUNCTIONS ====================
        
        function loadStockReports() {
            const stockHistory = getStockHistory();
            const periodFilter = document.getElementById('stockPeriodFilter').value;
            const typeFilter = document.getElementById('stockTypeFilter').value;
            const productFilter = document.getElementById('stockProductFilter').value;
            
            // Filter berdasarkan periode
            let filteredHistory = [...stockHistory];
            const now = new Date();
            
            if (periodFilter === 'today') {
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                filteredHistory = stockHistory.filter(record => {
                    const recordDate = new Date(record.id);
                    return recordDate >= today;
                });
            } else if (periodFilter === 'week') {
                const weekAgo = new Date(now);
                weekAgo.setDate(now.getDate() - 7);
                filteredHistory = stockHistory.filter(record => new Date(record.id) >= weekAgo);
            } else if (periodFilter === 'month') {
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                filteredHistory = stockHistory.filter(record => new Date(record.id) >= monthStart);
            }
            
            // Filter berdasarkan jenis
            if (typeFilter !== 'all') {
                filteredHistory = filteredHistory.filter(record => record.type === typeFilter);
            }
            
            // Filter berdasarkan produk
            if (productFilter !== 'all') {
                filteredHistory = filteredHistory.filter(record => record.productId.toString() === productFilter);
            }
            
            displayStockReports(filteredHistory);
            updateStockSummary(filteredHistory);
            
            // Perbarui filter produk
            updateStockProductFilter();
        }

        function displayStockReports(history) {
            const stockHistoryList = document.getElementById('stockHistoryList');
            
            if (history.length === 0) {
                stockHistoryList.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 20px; color: #7f8c8d;">
                            Belum ada data stok
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            
            history.sort((a, b) => b.id - a.id).forEach(record => {
                const typeClass = record.type === 'in' ? 'stock-in' : 
                                record.type === 'out' ? 'stock-out' : 'stock-adjustment';
                
                const typeText = record.type === 'in' ? 'Stok Masuk' : 
                               record.type === 'out' ? 'Stok Keluar' : 'Penyesuaian';
                
                const quantityText = record.type === 'out' ? `-${record.quantity}` : `+${record.quantity}`;
                
                html += `
                    <tr>
                        <td>${record.timestamp}</td>
                        <td>${record.productName}</td>
                        <td class="${typeClass}">${typeText}</td>
                        <td class="${typeClass}">${quantityText}</td>
                        <td>${record.previousStock}</td>
                        <td>${record.newStock}</td>
                        <td>${record.notes || '-'}</td>
                        <td>${record.user}</td>
                    </tr>
                `;
            });
            
            stockHistoryList.innerHTML = html;
        }

        function updateStockSummary(history) {
            let totalIn = 0;
            let totalOut = 0;
            let totalAdjustment = 0;
            
            history.forEach(record => {
                if (record.type === 'in') {
                    totalIn += record.quantity;
                } else if (record.type === 'out') {
                    totalOut += record.quantity;
                } else if (record.type === 'adjustment') {
                    totalAdjustment += Math.abs(record.quantity);
                }
            });
            
            document.getElementById('totalStockIn').textContent = totalIn;
            document.getElementById('totalStockOut').textContent = totalOut;
            document.getElementById('totalStockAdjustment').textContent = totalAdjustment;
            document.getElementById('totalStockChanges').textContent = history.length;
        }

        function updateStockProductFilter() {
            const products = getProducts();
            const productFilter = document.getElementById('stockProductFilter');
            
            // Simpan nilai yang dipilih
            const selectedValue = productFilter.value;
            
            // Kosongkan opsi
            productFilter.innerHTML = '<option value="all">Semua Produk</option>';
            
            // Tambahkan opsi produk
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = product.name;
                productFilter.appendChild(option);
            });
            
            // Kembalikan nilai yang dipilih jika masih ada
            if (selectedValue !== 'all' && products.some(p => p.id.toString() === selectedValue)) {
                productFilter.value = selectedValue;
            }
        }

        function filterStockReports() {
            loadStockReports();
        }

        function exportStockReports() {
            const stockHistory = getStockHistory();
            const periodFilter = document.getElementById('stockPeriodFilter').value;
            const typeFilter = document.getElementById('stockTypeFilter').value;
            const productFilter = document.getElementById('stockProductFilter').value;
            
            // Filter seperti di loadStockReports
            let filteredHistory = [...stockHistory];
            const now = new Date();
            
            if (periodFilter === 'today') {
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                filteredHistory = stockHistory.filter(record => {
                    const recordDate = new Date(record.id);
                    return recordDate >= today;
                });
            } else if (periodFilter === 'week') {
                const weekAgo = new Date(now);
                weekAgo.setDate(now.getDate() - 7);
                filteredHistory = stockHistory.filter(record => new Date(record.id) >= weekAgo);
            } else if (periodFilter === 'month') {
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                filteredHistory = stockHistory.filter(record => new Date(record.id) >= monthStart);
            }
            
            if (typeFilter !== 'all') {
                filteredHistory = filteredHistory.filter(record => record.type === typeFilter);
            }
            
            if (productFilter !== 'all') {
                filteredHistory = filteredHistory.filter(record => record.productId.toString() === productFilter);
            }
            
            if (filteredHistory.length === 0) {
                showNotification('Tidak ada data untuk diexport', 'error');
                return;
            }
            
            // Buat konten Excel
            let excelContent = "LAPORAN STOK - KASIR KONTAN BY SR\n";
            excelContent += `Periode: ${getStockFilterText(periodFilter)}\n`;
            excelContent += `Jenis: ${getStockTypeText(typeFilter)}\n`;
            excelContent += `Tanggal Export: ${new Date().toLocaleString('id-ID')}\n\n`;
            
            excelContent += "Tanggal\tProduk\tJenis\tJumlah\tStok Sebelum\tStok Sesudah\tKeterangan\tUser\n";
            
            filteredHistory.forEach(record => {
                const typeText = record.type === 'in' ? 'Stok Masuk' : 
                               record.type === 'out' ? 'Stok Keluar' : 'Penyesuaian';
                
                const quantityText = record.type === 'out' ? `-${record.quantity}` : `+${record.quantity}`;
                
                excelContent += `${record.timestamp}\t${record.productName}\t${typeText}\t${quantityText}\t${record.previousStock}\t${record.newStock}\t${record.notes || '-'}\t${record.user}\n`;
            });
            
            // Buat dan unduh file
            const blob = new Blob([excelContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `Laporan_Stok_${getStockFilterText(periodFilter)}_${new Date().toISOString().split('T')[0]}.txt`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification(`Laporan stok berhasil diexport!`);
        }

        function getStockFilterText(filter) {
            switch(filter) {
                case 'today': return 'Hari_Ini';
                case 'week': return 'Minggu_Ini';
                case 'month': return 'Bulan_Ini';
                default: return 'Semua_Data';
            }
        }

        function getStockTypeText(type) {
            switch(type) {
                case 'in': return 'Stok_Masuk';
                case 'out': return 'Stok_Keluar';
                case 'adjustment': return 'Penyesuaian';
                default: return 'Semua_Jenis';
            }
        }

        // ==================== USERS MANAGEMENT ====================
        
        function loadUsersList() {
            const users = getUsers();
            const usersList = document.getElementById('usersList');
            
            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
            
            Object.entries(users).forEach(([username, user]) => {
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--light); border-radius: 8px;">
                        <div>
                            <div style="font-weight: bold;">${user.name}</div>
                            <div style="color: #7f8c8d; font-size: 0.9em;">
                                ${user.role} - ${username}
                                ${user.createdBy ? `<br><small>Dibuat oleh: ${user.createdBy}</small>` : ''}
                            </div>
                        </div>
                        <div>
                            <button onclick="editUser('${username}')" style="background: var(--warning); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-right: 5px;">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            ${username !== currentUser.username ? `
                                <button onclick="resetUserPassword('${username}')" style="background: var(--info); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-right: 5px;">
                                    <i class="fas fa-key"></i> Reset Password
                                </button>
                                <button onclick="deleteUser('${username}')" style="background: var(--danger); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                                    <i class="fas fa-trash"></i> Hapus
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            usersList.innerHTML = html;
        }

        function showAddUserModal() {
            editingUserId = null;
            document.getElementById('userModalTitle').textContent = 'Tambah User';
            document.getElementById('userId').value = '';
            document.getElementById('userName').value = '';
            document.getElementById('userUsername').value = '';
            document.getElementById('userRole').value = 'kasir';
            document.getElementById('userPassword').value = '';
            document.getElementById('userModal').classList.add('active');
        }

        function editUser(username) {
            const users = getUsers();
            const user = users[username];
            
            if (user) {
                editingUserId = username;
                document.getElementById('userModalTitle').textContent = 'Edit User';
                document.getElementById('userId').value = username;
                document.getElementById('userName').value = user.name;
                document.getElementById('userUsername').value = username;
                document.getElementById('userRole').value = user.role;
                document.getElementById('userPassword').value = '';
                document.getElementById('userModal').classList.add('active');
            }
        }

        function hideUserModal() {
            document.getElementById('userModal').classList.remove('active');
            editingUserId = null;
        }

        function saveUser() {
            const name = document.getElementById('userName').value;
            const username = document.getElementById('userUsername').value;
            const role = document.getElementById('userRole').value;
            const password = document.getElementById('userPassword').value;
            
            if (!name || !username || !role) {
                showNotification('Harap isi semua field!', 'error');
                return;
            }
            
            const users = getUsers();
            
            if (editingUserId) {
                // Edit existing user
                if (users[editingUserId]) {
                    users[username] = {
                        ...users[editingUserId],
                        name,
                        role
                    };
                    if (password) {
                        if (password.length < 6) {
                            showNotification('Password minimal 6 karakter!', 'error');
                            return;
                        }
                        users[username].password = password;
                    }
                    // Remove old username if changed
                    if (username !== editingUserId) {
                        delete users[editingUserId];
                    }
                }
                showNotification('User berhasil diupdate!');
            } else {
                // Add new user
                if (users[username]) {
                    showNotification('Username sudah ada!', 'error');
                    return;
                }
                if (!password || password.length < 6) {
                    showNotification('Password minimal 6 karakter!', 'error');
                    return;
                }
                users[username] = {
                    password,
                    role,
                    name,
                    createdBy: currentUser.username
                };
                showNotification('User berhasil ditambahkan!');
            }
            
            saveUsers(users);
            hideUserModal();
            loadUsersList();
            loadLoginUsers();
        }

        function resetUserPassword(username) {
            const newPassword = prompt(`Reset password untuk ${username}:\nMasukkan password baru (min. 6 karakter):`);
            
            if (newPassword && newPassword.length >= 6) {
                const users = getUsers();
                if (users[username]) {
                    users[username].password = newPassword;
                    saveUsers(users);
                    showNotification(`Password untuk ${username} berhasil direset!`);
                }
            } else if (newPassword) {
                showNotification('Password minimal 6 karakter!', 'error');
            }
        }

        function deleteUser(username) {
            if (username === currentUser.username) {
                showNotification('Tidak bisa menghapus user yang sedang login!', 'error');
                return;
            }
            
            if (!confirm(`Apakah Anda yakin ingin menghapus user ${username}?`)) {
                return;
            }
            
            const users = getUsers();
            delete users[username];
            saveUsers(users);
            
            showNotification('User berhasil dihapus!');
            loadUsersList();
            loadLoginUsers();
        }

        // ==================== MENU & CART SYSTEM ====================
        
        function loadMenuItems() {
            const products = getProducts();
            const menuGrid = document.getElementById('menuGrid');
            
            if (products.length === 0) {
                menuGrid.innerHTML = '<p style="text-align: center; padding: 20px; color: #7f8c8d;">Belum ada produk</p>';
                return;
            }
            
            let html = '';
            
            products.forEach(product => {
                const isOutOfStock = product.stock === 0;
                const isLowStock = product.stock > 0 && product.stock < 10;
                
                html += `
                    <div class="menu-item">
                        ${isLowStock ? '<div class="discount-badge">STOK MENIPIS</div>' : ''}
                        <h3>${product.name}</h3>
                        <div class="price">${formatCurrency(product.price)}</div>
                        <div class="stock-info ${isOutOfStock ? 'out-of-stock' : ''}">
                            ${isOutOfStock ? '🛒 Stok Habis' : `📦 Stok: ${product.stock}`}
                        </div>
                        <p style="color: #7f8c8d; font-size: 0.9em;">${product.description}</p>
                        <button class="add-to-cart" onclick="addToCart(${product.id})" ${isOutOfStock ? 'disabled' : ''}>
                            <i class="fas fa-cart-plus"></i> 
                            ${isOutOfStock ? 'Stok Habis' : 'Tambah'}
                        </button>
                    </div>
                `;
            });
            
            menuGrid.innerHTML = html;
        }

        function filterMenu() {
            const searchTerm = document.getElementById('menuSearch').value.toLowerCase();
            const menuItems = document.querySelectorAll('.menu-item');
            
            menuItems.forEach(item => {
                const itemName = item.querySelector('h3').textContent.toLowerCase();
                if (itemName.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function addToCart(productId) {
            const products = getProducts();
            const product = products.find(p => p.id === productId);
            
            if (!product) {
                showNotification('Produk tidak ditemukan!', 'error');
                return;
            }
            
            if (product.stock === 0) {
                showNotification('Stok produk habis!', 'error');
                return;
            }
            
            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                if (existingItem.quantity >= product.stock) {
                    showNotification('Stok tidak mencukupi!', 'error');
                    return;
                }
                existingItem.quantity += 1;
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: 1
                });
            }
            
            updateCartDisplay();
            showNotification(`${product.name} ditambahkan ke keranjang`);
        }

        function updateCartDisplay() {
            const cartItems = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<p style="text-align: center; padding: 20px; color: #7f8c8d;">Keranjang kosong</p>';
                cartTotal.textContent = 'Total: Rp 0';
                return;
            }
            
            let total = 0;
            let itemsHTML = '';
            
            cart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                
                itemsHTML += `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <strong>${item.name}</strong>
                            <div>${formatCurrency(item.price)} x ${item.quantity}</div>
                        </div>
                        <div class="cart-item-actions">
                            <strong>${formatCurrency(itemTotal)}</strong>
                            <button class="quantity-btn decrease" onclick="decreaseCartQuantity(${index})">
                                <i class="fas fa-minus"></i>
                            </button>
                            <span style="min-width: 30px; text-align: center;">${item.quantity}</span>
                            <button class="quantity-btn increase" onclick="increaseCartQuantity(${index})">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button onclick="removeFromCart(${index})" style="background: var(--danger); color: white; border: none; padding: 5px 10px; border-radius: 3px; margin-left: 10px; cursor: pointer;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            cartItems.innerHTML = itemsHTML;
            cartTotal.textContent = `Total: ${formatCurrency(total)}`;
        }

        function increaseCartQuantity(index) {
            const products = getProducts();
            const product = products.find(p => p.id === cart[index].id);
            
            if (cart[index].quantity >= product.stock) {
                showNotification('Stok tidak mencukupi!', 'error');
                return;
            }
            
            cart[index].quantity += 1;
            updateCartDisplay();
        }

        function decreaseCartQuantity(index) {
            if (cart[index].quantity > 1) {
                cart[index].quantity -= 1;
                updateCartDisplay();
            } else {
                removeFromCart(index);
            }
        }

        function removeFromCart(index) {
            const removedItem = cart[index];
            cart.splice(index, 1);
            updateCartDisplay();
            showNotification(`${removedItem.name} dihapus dari keranjang`);
        }

        function clearCart() {
            if (cart.length === 0) {
                showNotification('Keranjang sudah kosong', 'error');
                return;
            }
            
            if (confirm('Kosongkan keranjang?')) {
                cart = [];
                updateCartDisplay();
                showNotification('Keranjang dikosongkan');
            }
        }

        // ==================== CHECKOUT & PAYMENT ====================
        
        function showCheckoutModal() {
            if (cart.length === 0) {
                showNotification('Keranjang kosong', 'error');
                return;
            }
            
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            document.getElementById('checkoutTotal').textContent = formatCurrency(total);
            
            // Reset payment method
            selectedPaymentMethod = null;
            document.querySelectorAll('.payment-method').forEach(method => {
                method.classList.remove('selected');
            });
            
            document.getElementById('checkoutModal').classList.add('active');
        }

        function hideCheckoutModal() {
            document.getElementById('checkoutModal').classList.remove('active');
            selectedPaymentMethod = null;
        }

        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            
            document.querySelectorAll('.payment-method').forEach(m => {
                m.classList.remove('selected');
            });
            document.getElementById(method + 'Method').classList.add('selected');
        }

        function confirmCheckout() {
            if (!selectedPaymentMethod) {
                showNotification('Pilih metode pembayaran terlebih dahulu!', 'error');
                return;
            }
            
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            // Update product stocks dan catat stok keluar
            const products = getProducts();
            cart.forEach(cartItem => {
                const product = products.find(p => p.id === cartItem.id);
                if (product) {
                    const previousStock = product.stock;
                    product.stock -= cartItem.quantity;
                    
                    // Catat stok keluar
                    recordStockChange(
                        product.id, 
                        'out', 
                        cartItem.quantity, 
                        previousStock, 
                        `Penjualan - Transaksi #${Date.now()}`
                    );
                }
            });
            saveProducts(products);
            
            const transaction = {
                id: Date.now(),
                date: new Date().toLocaleString('id-ID'),
                items: [...cart],
                total: total,
                cashier: currentUser.name,
                paymentMethod: selectedPaymentMethod
            };
            
            const transactions = getTransactions();
            transactions.push(transaction);
            saveTransactions(transactions);
            
            // Print receipt
            printReceipt(transaction);
            
            showNotification(`Transaksi berhasil! Total: ${formatCurrency(total)}`);
            
            cart = [];
            updateCartDisplay();
            hideCheckoutModal();
            
            updateDashboard();
            updateIncomeSummary();
            loadMenuItems();
            loadStockReports(); // Perbarui laporan stok
        }

        // ==================== RECEIPT PRINTING ====================
        
        function printReceipt(transaction) {
            const printSection = document.getElementById('printSection');
            let html = `
                <div style="font-family: 'Courier New', monospace; max-width: 300px; margin: 0 auto; font-size: 12px;">
                    <div style="text-align: center; margin-bottom: 10px;">
                        <h2 style="margin: 0; font-size: 16px;">KASIR KONTAN By SR</h2>
                        <p style="margin: 2px 0;">Sistem Kasir Restoran</p>
                        <p style="margin: 2px 0;">${transaction.date}</p>
                        <hr style="border: 1px dashed #000; margin: 8px 0;">
                    </div>
                    
                    <div style="margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>Kasir:</span>
                            <span>${transaction.cashier}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Metode:</span>
                            <span>${transaction.paymentMethod === 'cash' ? 'TUNAI' : 'QRIS'}</span>
                        </div>
                    </div>
                    
                    <hr style="border: 1px dashed #000; margin: 8px 0;">
                    
                    <div style="margin-bottom: 8px;">
            `;
            
            transaction.items.forEach(item => {
                html += `
                    <div style="margin-bottom: 4px;">
                        <div>${item.name}</div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>${item.quantity} x ${formatCurrency(item.price)}</span>
                            <span>${formatCurrency(item.price * item.quantity)}</span>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                    
                    <hr style="border: 1px dashed #000; margin: 8px 0;">
                    
                    <div style="margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; font-weight: bold;">
                            <span>TOTAL:</span>
                            <span>${formatCurrency(transaction.total)}</span>
                        </div>
                    </div>
                    
                    <hr style="border: 1px dashed #000; margin: 8px 0;">
                    
                    <div style="text-align: center; margin-top: 10px;">
                        <p style="margin: 3px 0;">Terima kasih atas kunjungan Anda</p>
                        <p style="margin: 3px 0;">Selamat menikmati makanan</p>
                    </div>
                </div>
            `;
            
            printSection.innerHTML = html;
            
            // Trigger print
            window.print();
        }

        // ==================== REPORTS & DASHBOARD ====================
        
        function updateDashboard() {
            const transactions = getTransactions();
            const today = new Date().toDateString();
            
            const todayTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.id).toDateString();
                return transactionDate === today;
            });
            
            const todayRevenue = todayTransactions.reduce((sum, t) => sum + t.total, 0);
            const avgTransaction = todayTransactions.length > 0 ? todayRevenue / todayTransactions.length : 0;
            
            document.getElementById('todaySales').textContent = todayTransactions.length;
            document.getElementById('todayRevenue').textContent = formatCurrency(todayRevenue);
            document.getElementById('avgTransaction').textContent = formatCurrency(Math.round(avgTransaction));
            
            // Update popular items count
            let totalItems = 0;
            transactions.forEach(transaction => {
                transaction.items.forEach(item => {
                    totalItems += item.quantity;
                });
            });
            document.getElementById('popularItemCount').textContent = totalItems;
            
            // Update charts
            updateCharts();
        }

        function updateIncomeSummary() {
            const transactions = getTransactions();
            const today = new Date();
            const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const weekAgo = new Date(today);
            weekAgo.setDate(today.getDate() - 7);
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
            
            const dailyIncome = transactions
                .filter(t => new Date(t.id) >= todayStart)
                .reduce((sum, t) => sum + t.total, 0);
                
            const weeklyIncome = transactions
                .filter(t => new Date(t.id) >= weekAgo)
                .reduce((sum, t) => sum + t.total, 0);
                
            const monthlyIncome = transactions
                .filter(t => {
                    const transactionDate = new Date(t.id);
                    return transactionDate >= monthStart && transactionDate < nextMonth;
                })
                .reduce((sum, t) => sum + t.total, 0);
            
            document.getElementById('dailyIncome').textContent = formatCurrency(dailyIncome);
            document.getElementById('weeklyIncome').textContent = formatCurrency(weeklyIncome);
            document.getElementById('monthlyIncome').textContent = formatCurrency(monthlyIncome);
            document.getElementById('totalTransactions').textContent = transactions.length;
        }

        function updateCharts() {
            updatePopularProductsChart();
            updateDailyRevenueChart();
        }

        function updatePopularProductsChart() {
            const transactions = getTransactions();
            const itemCount = {};
            
            transactions.forEach(transaction => {
                transaction.items.forEach(item => {
                    if (!itemCount[item.name]) {
                        itemCount[item.name] = 0;
                    }
                    itemCount[item.name] += item.quantity;
                });
            });
            
            const sortedItems = Object.entries(itemCount).sort((a, b) => b[1] - a[1]).slice(0, 5);
            
            const ctx = document.getElementById('popularProductsChart').getContext('2d');
            
            if (popularProductsChart) {
                popularProductsChart.destroy();
            }
            
            if (sortedItems.length === 0) {
                ctx.font = '16px Arial';
                ctx.fillStyle = '#7f8c8d';
                ctx.textAlign = 'center';
                ctx.fillText('Belum ada data transaksi', 150, 75);
                return;
            }
            
            const labels = sortedItems.map(([name]) => name);
            const data = sortedItems.map(([, count]) => count);
            const total = data.reduce((sum, value) => sum + value, 0);
            const backgroundColors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'
            ];
            
            popularProductsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        }

        function updateDailyRevenueChart() {
            const transactions = getTransactions();
            const last7Days = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                last7Days.push(date.toDateString());
            }
            
            const dailyRevenue = last7Days.map(day => {
                const dayRevenue = transactions
                    .filter(t => new Date(t.id).toDateString() === day)
                    .reduce((sum, t) => sum + t.total, 0);
                return dayRevenue;
            });
            
            const ctx = document.getElementById('dailyRevenueChart').getContext('2d');
            
            if (dailyRevenueChart) {
                dailyRevenueChart.destroy();
            }
            
            const dayLabels = last7Days.map(date => {
                const d = new Date(date);
                return `${d.getDate()}/${d.getMonth() + 1}`;
            });
            
            dailyRevenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dayLabels,
                    datasets: [{
                        label: 'Pendapatan Harian',
                        data: dailyRevenue,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Rp ' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // ==================== REPORTS MANAGEMENT ====================
        
        function loadReports() {
            const transactions = getTransactions();
            const filter = document.getElementById('reportFilter').value;
            
            let filteredTransactions = [...transactions];
            const now = new Date();
            
            if (filter === 'today') {
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                filteredTransactions = transactions.filter(t => new Date(t.id) >= today);
            } else if (filter === 'week') {
                const weekAgo = new Date(now);
                weekAgo.setDate(now.getDate() - 7);
                filteredTransactions = transactions.filter(t => new Date(t.id) >= weekAgo);
            } else if (filter === 'month') {
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                filteredTransactions = transactions.filter(t => new Date(t.id) >= monthStart);
            }
            
            displayReports(filteredTransactions);
        }

        function displayReports(transactions) {
            const reportsList = document.getElementById('reportsList');
            
            if (transactions.length === 0) {
                reportsList.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 20px; color: #7f8c8d;">
                            Belum ada transaksi
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            
            transactions.sort((a, b) => b.id - a.id).forEach((transaction, index) => {
                const itemsText = transaction.items.map(item => 
                    `${item.name} (${item.quantity}x)`
                ).join(', ');
                
                const paymentText = transaction.paymentMethod === 'cash' ? 'Tunai' : 'QRIS';
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${transaction.date}</td>
                        <td>${transaction.cashier}</td>
                        <td>${itemsText}</td>
                        <td>${formatCurrency(transaction.total)}</td>
                        <td>${paymentText}</td>
                        <td>
                            ${currentUser.role === 'admin' ? `
                                <div class="action-buttons">
                                    <button class="edit-btn" onclick="showEditTransactionModal(${transaction.id})">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="delete-btn" onclick="deleteTransaction(${transaction.id})">
                                        <i class="fas fa-trash"></i> Hapus
                                    </button>
                                </div>
                            ` : '<span class="access-denied">Tidak ada akses</span>'}
                        </td>
                    </tr>
                `;
            });
            
            reportsList.innerHTML = html;
        }

        function filterReports() {
            loadReports();
        }

        // ==================== PRINT & EXPORT FUNCTIONS ====================
        
        function showPrintPreview() {
            const transactions = getTransactions();
            const filter = document.getElementById('reportFilter').value;
            
            let filteredTransactions = [...transactions];
            const now = new Date();
            
            if (filter === 'today') {
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                filteredTransactions = transactions.filter(t => new Date(t.id) >= today);
            } else if (filter === 'week') {
                const weekAgo = new Date(now);
                weekAgo.setDate(now.getDate() - 7);
                filteredTransactions = transactions.filter(t => new Date(t.id) >= weekAgo);
            } else if (filter === 'month') {
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                filteredTransactions = transactions.filter(t => new Date(t.id) >= monthStart);
            }
            
            if (filteredTransactions.length === 0) {
                showNotification('Tidak ada data untuk dicetak', 'error');
                return;
            }
            
            const printPreviewContent = document.getElementById('printPreviewContent');
            let html = `
                <div style="font-family: Arial, sans-serif; max-width: 100%;">
                    <div style="text-align: center; margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                        <h1 style="margin: 0; color: #2c3e50;">KASIR KONTAN By SR</h1>
                        <h2 style="margin: 5px 0; color: #7f8c8d;">Laporan Transaksi</h2>
                        <p style="margin: 5px 0; font-weight: bold;">Periode: ${getFilterText(filter)}</p>
                        <p style="margin: 5px 0;">Tanggal Cetak: ${new Date().toLocaleString('id-ID')}</p>
                    </div>
                    
                    <table class="print-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Tanggal</th>
                                <th>Kasir</th>
                                <th>Items</th>
                                <th>Total</th>
                                <th>Metode Bayar</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            let totalRevenue = 0;
            let totalTransactions = filteredTransactions.length;
            
            filteredTransactions.forEach((transaction, index) => {
                const itemsText = transaction.items.map(item => 
                    `${item.name} (${item.quantity}x)`
                ).join(', ');
                
                const paymentText = transaction.paymentMethod === 'cash' ? 'Tunai' : 'QRIS';
                
                totalRevenue += transaction.total;
                
                html += `
                    <tr>
                        <td style="padding: 8px;">${index + 1}</td>
                        <td style="padding: 8px;">${transaction.date}</td>
                        <td style="padding: 8px;">${transaction.cashier}</td>
                        <td style="padding: 8px;">${itemsText}</td>
                        <td style="padding: 8px;">${formatCurrency(transaction.total)}</td>
                        <td style="padding: 8px;">${paymentText}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                        <tfoot>
                            <tr style="background-color: #f0f0f0;">
                                <td colspan="3" style="padding: 10px; text-align: right; font-weight: bold;">Total:</td>
                                <td style="padding: 10px; font-weight: bold;">${totalTransactions} Transaksi</td>
                                <td colspan="2" style="padding: 10px; font-weight: bold;">${formatCurrency(totalRevenue)}</td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <div style="margin-top: 30px; padding: 20px; border-top: 2px solid #ddd;">
                        <div style="display: flex; justify-content: space-between;">
                            <div>
                                <p><strong>Dicetak oleh:</strong> ${currentUser.name}</p>
                            </div>
                            <div style="text-align: right;">
                                <p><strong>Tanggal:</strong> ${new Date().toLocaleDateString('id-ID')}</p>
                                <p><strong>Jam:</strong> ${new Date().toLocaleTimeString('id-ID')}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            printPreviewContent.innerHTML = html;
            document.getElementById('printPreviewModal').classList.add('active');
        }

        function hidePrintPreviewModal() {
            document.getElementById('printPreviewModal').classList.remove('active');
        }

        function printReports() {
            const printSection = document.getElementById('printSection');
            printSection.innerHTML = document.getElementById('printPreviewContent').innerHTML;
            
            window.print();
            hidePrintPreviewModal();
        }

        function exportReports() {
            const transactions = getTransactions();
            const filter = document.getElementById('reportFilter').value;
            
            let filteredTransactions = [...transactions];
            const now = new Date();
            
            if (filter === 'today') {
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                filteredTransactions = transactions.filter(t => new Date(t.id) >= today);
            } else if (filter === 'week') {
                const weekAgo = new Date(now);
                weekAgo.setDate(now.getDate() - 7);
                filteredTransactions = transactions.filter(t => new Date(t.id) >= weekAgo);
            } else if (filter === 'month') {
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                filteredTransactions = transactions.filter(t => new Date(t.id) >= monthStart);
            }
            
            if (filteredTransactions.length === 0) {
                showNotification('Tidak ada data untuk diexport', 'error');
                return;
            }
            
            // Create Excel content
            let excelContent = "LAPORAN TRANSAKSI - KASIR KONTAN BY SR\n";
            excelContent += `Periode: ${getFilterText(filter)}\n`;
            excelContent += `Tanggal Export: ${new Date().toLocaleString('id-ID')}\n\n`;
            
            excelContent += "No\tTanggal\tKasir\tItems\tTotal\tMetode Bayar\n";
            
            let totalRevenue = 0;
            
            filteredTransactions.forEach((transaction, index) => {
                const itemsText = transaction.items.map(item => 
                    `${item.name} (${item.quantity}x)`
                ).join('; ');
                
                const paymentText = transaction.paymentMethod === 'cash' ? 'Tunai' : 'QRIS';
                
                totalRevenue += transaction.total;
                
                excelContent += `${index + 1}\t${transaction.date}\t${transaction.cashier}\t"${itemsText}"\t${transaction.total}\t${paymentText}\n`;
            });
            
            excelContent += `\nTotal Transaksi: ${filteredTransactions.length}\n`;
            excelContent += `Total Pendapatan: ${formatCurrency(totalRevenue)}\n`;
            excelContent += `Dicetak oleh: ${currentUser.name}`;
            
            // Create and download file
            const blob = new Blob([excelContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `Laporan_${getFilterText(filter)}_${new Date().toISOString().split('T')[0]}.txt`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification(`Laporan ${getFilterText(filter)} berhasil diexport!`);
        }

        function getFilterText(filter) {
            switch(filter) {
                case 'today': return 'Hari_Ini';
                case 'week': return 'Minggu_Ini';
                case 'month': return 'Bulan_Ini';
                default: return 'Semua_Data';
            }
        }

        // ==================== CLOSING FUNCTIONS ====================
        
        function updateClosingSummary() {
            const transactions = getTransactions();
            const now = new Date();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
            
            const monthlyTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.id);
                return transactionDate >= monthStart && transactionDate < nextMonth;
            });
            
            const monthlyIncome = monthlyTransactions.reduce((sum, t) => sum + t.total, 0);
            const avgTransaction = monthlyTransactions.length > 0 ? monthlyIncome / monthlyTransactions.length : 0;
            
            document.getElementById('closingMonthlyIncome').textContent = formatCurrency(monthlyIncome);
            document.getElementById('closingTotalTransactions').textContent = monthlyTransactions.length;
            document.getElementById('closingAvgTransaction').textContent = formatCurrency(Math.round(avgTransaction));
            
            const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                               'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            document.getElementById('closingPeriod').textContent = `${monthNames[now.getMonth()]} ${now.getFullYear()}`;
        }

        function loadClosingHistory() {
            const history = getClosingHistory();
            const closingHistory = document.getElementById('closingHistory');
            
            if (history.length === 0) {
                closingHistory.innerHTML = `
                    <p style="text-align: center; padding: 20px; color: #7f8c8d;">
                        Belum ada riwayat tutup buku
                    </p>
                `;
                return;
            }
            
            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
            
            history.forEach((record, index) => {
                html += `
                    <div style="padding: 15px; background: var(--light); border-radius: 8px;">
                        <div style="font-weight: bold;">Tutup Buku ${record.period}</div>
                        <div style="color: #7f8c8d; font-size: 0.9em;">
                            Total: ${formatCurrency(record.totalIncome)} | 
                            Transaksi: ${record.totalTransactions} | 
                            Oleh: ${record.processedBy}
                        </div>
                        <div style="color: #7f8c8d; font-size: 0.8em;">
                            ${record.timestamp}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            closingHistory.innerHTML = html;
        }

        // ==================== PASSWORD MANAGEMENT ====================
        
        function showChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.add('active');
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        function hideChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.remove('active');
        }

        function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showNotification('Harap isi semua field!', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showNotification('Password baru tidak cocok!', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showNotification('Password minimal 6 karakter!', 'error');
                return;
            }
            
            const users = getUsers();
            
            if (users[currentUser.username].password !== currentPassword) {
                showNotification('Password saat ini salah!', 'error');
                return;
            }
            
            users[currentUser.username].password = newPassword;
            saveUsers(users);
            
            showNotification('Password berhasil diubah!');
            hideChangePasswordModal();
        }

        // ==================== INITIALIZATION ====================
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
            loadLoginUsers();
            
            document.getElementById('loginPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });

            document.getElementById('confirmPassword')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    changePassword();
                }
            });

            document.getElementById('userPassword')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveUser();
                }
            });
        });

    </script>
</body>
</html>
